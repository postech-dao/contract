# 컨트랙트 VM에 대한 이해

컨트랙트 VM을 작성하기 위해서는 모든 콜로니 체인 개발자들은 **다음과 같은 사항 모두에 대해** 수준 높은 이해를 가지고 있어야합니다.

## 트랜잭션이 실패할 때 어떻게 해야하는가?
- Panic? Panic시 메세지는? stack unwind는 전부 실행하고 가스가 청구되는가? stack unwind도 생략하고 싶다면?
- `Result` 등으로 표현할 수 있는 부분도 있는가?
- 에러가 발생하면 무조건 state를 revert하는가? 일부만 반영하고 에러를 발생시킬 수 있는가?

## 트랜잭션 로그
- 일단 Ethereum의 'transaction receipt'가 어떤건지 알아봅시다
- 비슷한게 있는가? 어떻게 emit 하는가?
- 에러 핸들링과 어떤 관계를 가지는가? (대용으로 사용가능한가?)
- (컨센서스에 들어가는 transaction receipt 등과 달리) 순수 디버깅 용도로 사용하는 로그는 어떻게 남기는가? 어떻게 확인하는가?
- VM에서 코드 실행중에 나온 stdout이나 stderr를 풀노드나 VM context (integration test 등의 용도로 제공해주는)에서 확인할 수 있는가?

## VM
- 코드가 컴파일되면서 초기화 혹은 트랜잭션의 엔트리포인트가 어떻게 지정되는가?
- 내부적으로 VM이 어떤 WASM 런타임을 사용하는가?
- non-deterministic 한 코드를 컴파일타임에 감지할 수 있는가? 아니라면 어떤 것들을 주의해야하는가?
- 실행 컨텍스트가 어떻게 관리되는가? 트랜잭션 실행시에만 컨텍스트가 새로 로드된다면 매번 스테이트를 어떻게 복구하는가?
- 컨트랙트의 코드와 상태가 분리되어있는가?

## 가스모델
- 코드 실행에 가스가 어떻게 매겨지는가?
- 컨트랙트 밖의 다른 코드 (다른 컨트랙트, 혹은 호스트 코드) 등을 호출 했을때 가스가 어떻게 매겨지는가?
- 스토리지에는 가스가 어떻게 매겨지는가? 스토리지의 할당/삭제를 유발하는 포인트가 (컨트랙트 상태의 조작 외에) 어떤 것들인가?
- 트랜잭션 페이로드의 크기에 대해서는 가스가 어떻게 매겨지는가?
- 메모리 할당 (힙, 스택 등)에 대해서는 가스가 어떻게 매겨지는가?

## 테스팅
- 유닛테스트(Rust 코드레벨), 통합테스트(VM레벨), e2e테스트(풀노드레벨)을 각각 유지할 요인이 있는가? (서로 커버리지가 다른가 or 동작이 달라질 수 있는가?)
- 통합테스트와 e2e테스트를 하기 위한 툴에 어떤 것이 있는가?

